{% extends "base_with_sidebar.html" %}

{% block header_btns %}
    <a href="#" class="am-btn am-btn-secondary">
        <i class="am-header-icon am-icon-user"></i>
        <span class="am-header-nav-title">
            账号
        </span>
    </a>
    <a href="{{url_for('logout')}}" class="am-btn am-btn-secondary">
        <i class="am-header-icon am-icon-power-off"></i>
        <span class="am-header-nav-title">
            退出
        </span>
    </a>
{% endblock %}
{% block content %}
    <div class="admin-content-body">
        <div class="am-cf am-padding am-padding-bottom-0">
            <div class="am-cf"><strong class="am-text-primary am-text-lg">定时任务</strong> / <small>任务配置</small></div>
        </div>
        <hr>
        <div class="am-g">
            <div class="am-u-sm-12">
                <div class="am-btn-group am-btn-group-xs">
                    <button class="am-btn am-btn-default am-btn" id="btnCreateSchedule">新建计划</button>
                </div>
                <table class="am-table am-table-striped am-table-hover table-main" id="schedule_list">
                    <thead>
                        <tr>
                            <th class="table-id am-hide-sm-only">ID</th>
                            <th class="table-title">计划名称</th>
                            <th class="table-title">任务名称</th>
                            <th class="table-title">调度类型</th>
                            <th class="table-title am-hide-sm-only">有效</th>
                            <th class="table-title am-hide-sm-only">执行计数</th>
                            <th class="table-title am-hide-sm-only">最后更新</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="am-modal am-modal-alert" tabindex="-1" id="errorModal">
        <div class="am-modal-dialog">
            <div class="am-modal-hd">错误</div>
            <div class="am-modal-bd" id="error_msg">

            </div>
            <div class="am-modal-footer">
                <span class="am-modal-btn">确定</span>
            </div>
        </div>
    </div>

    <div class="am-modal" id="createSchedule">
        <div class="am-modal-dialog" style="z-index: 101;">
            <div class="am-modal-hd">新建计划
            <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
            </div>
            <div class="am-modal-bd">
                <form action="" class="am-form">
                    <fieldset>
                        <div class="am-form-group">
                            <input type="text" id="createScheduleName" minlength="3" data-foolish-msg="请输入正确的计划名称"
                                   placeholder="输入计划名称" required/>
                        </div>
                        <div class="am-form-group">
                            <select data-am-selected="{btnWidth: '100%',placeholder:'选择任务'}" id="createScheduleTask">
                            </select>
                        </div>
                        <div class="am-form-group">
                            <input type="text" id="createScheduleArgs" minlength="3" data-foolish-msg="请输入正确的args参数"
                                   placeholder="输入args(json格式)" required/>
                        </div>
                        <div class="am-form-group">
                            <input type="text" id="createScheduleKwargs" minlength="3" data-foolish-msg="请输入正确的kwargs参数"
                                   placeholder="输入kwargs(json格式)" required/>
                        </div>
                        <div class="am-panel am-panel-secondary">
                            <div class="am-panel-hd" style="padding:0px;">
                                <select data-am-selected="{btnWidth: '100%'}" id="runTypeSelect">
                                    <option value="interval" selected>间隔时间</option>
                                    <option value="crontab">特定时间</option>
                                </select>
                            </div>
                            <div class="am-panel-bd am-g">
                                <div id="intervalPannel">
                                    <div class="am-form-group am-u-sm-6">
                                        <input type="text" id="createScheduleEvery" placeholder="Every" required/>
                                    </div>
                                    <div class="am-u-sm-6">
                                        <select data-am-selected="{btnWidth: '100%'}" id="createSchedulePeriod">
                                            <option value="microseconds">毫秒</option>
                                            <option value="seconds">秒</option>
                                            <option value="minutes">分钟</option>
                                            <option value="hours" selected>小时</option>
                                            <option value="days">天</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="crontabPannel">
                                    <ul class="am-avg-sm-5 am-thumbnails">
                                        <li class="am-thumbnail" style="border:0px;">分</li>
                                        <li class="am-thumbnail" style="border:0px;">时</li>
                                        <li class="am-thumbnail" style="border:0px;">天(周)</li>
                                        <li class="am-thumbnail" style="border:0px;">天(月)</li>
                                        <li class="am-thumbnail" style="border:0px;">月(年)</li>
                                    </ul>
                                    <ul class="am-avg-sm-5 am-thumbnails">
                                        <li class="am-thumbnail" style="border:0px;">
                                            <input type="text" id="createScheduleCrontab1" maxlength="2" placeholder="*" required/>
                                        </li>
                                        <li class="am-thumbnail" style="border:0px;">
                                            <input type="text" id="createScheduleCrontab2" maxlength="2" placeholder="*" required/>
                                        </li>
                                        <li class="am-thumbnail" style="border:0px;">
                                            <input type="text" id="createScheduleCrontab3" maxlength="2" placeholder="*" required/>
                                        </li>
                                        <li class="am-thumbnail" style="border:0px;">
                                            <input type="text" id="createScheduleCrontab4" maxlength="2" placeholder="*" required/>
                                        </li>
                                        <li class="am-thumbnail" style="border:0px;">
                                            <input type="text" id="createScheduleCrontab5" maxlength="2" placeholder="*" required/>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="am-u-sm-3">
                            <label class="am-checkbox">
                                <input id="createScheduleEnabled" type="checkbox" checked="checked" value="" data-am-ucheck checked> 有效
                            </label>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="am-modal-footer">
                <span class="am-modal-btn" id="createScheduleCommit">确定</span>
            </div>
        </div>
    </div>

{% endblock %}

{% block js %}
<script language="JavaScript">
    $(document).ready(function() {

        //手工展开对应的主菜单
        $("#sub-menu-task").collapse('open');

        load_schedule();
        load_task();

        $("#intervalPannel").show();
        $("#crontabPannel").hide();

        $("#btnCreateSchedule").click(function(){
            $("#createSchedule").modal({
                width: 400,
                dimmer:false
            })
        });

        $("#runTypeSelect").change(function(){
            run_type = $(this).val()
            if(run_type=='interval'){
                $("#intervalPannel").show();
                $("#crontabPannel").hide();
            }else if(run_type=="crontab"){
                $("#crontabPannel").show();
                $("#intervalPannel").hide();
            }
        });

        $("#createScheduleCommit").click(function(){
            name=$('#createScheduleName').val();
            task=$('#createScheduleTask').val();
            args=$('#createScheduleArgs').val();
            kwargs=$('#createScheduleKwargs').val();
            if($('#createScheduleEnabled').is(':checked')){
                enabled=1
            }else{
                enabled=0
            }
            if($('#runTypeSelect').val()=='interval'){
                every=$('#createScheduleEvery').val();
                period=$('#createSchedulePeriod').val();
                minute=null;
                hour=null;
                day_of_week=null;
                day_of_month=null;
                month_of_year=null;
            }else if ($('#runTypeSelect').val()=='crontab'){
                every=null;
                period=null;
                minute=$('#createScheduleCrontab1').val();
                hour=$('#createScheduleCrontab2').val();
                day_of_week=$('#createScheduleCrontab3').val();
                day_of_month=$('#createScheduleCrontab4').val();
                month_of_year=$('#createScheduleCrontab5').val();
            }
            create_schedule(name,task,args,kwargs,enabled,every,period,minute,hour,day_of_week,day_of_month,month_of_year)
        });
    });
    function create_schedule(name,task,args,kwargs,enabled,every,period,minute,hour,day_of_week,day_of_month,month_of_year){
        $.AMUI.progress.start();
        console.log("start load user list");
        jQuery.ajax({
            url: "{{url_for('task_config__schedule')}}",
            dataType: "json",
            data: {'name':name,'task':task,'args':args,'kwargs':kwargs,'enabled':enabled,'every':every,'period':period,'minute':minute,'hour':hour,'day_of_week':day_of_week,'day_of_month':day_of_month,'month_of_year':month_of_year},
            type: "PUT",
            timeout : timeout,
            success: function(response) {
                $.AMUI.progress.done();
                console.log(response);
                load_schedule();
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                $.AMUI.progress.done();
                //call failed
                console.log("error");
                $("#error_msg").html("网络连接异常，请稍后重试。");
                $("#errorModal").modal("toggle");
            }
        });
    }
    function load_schedule(){
        $.AMUI.progress.start();
        console.log("start load schedule list");
        jQuery.ajax({
            url: "{{url_for('task_config__schedule')}}",
            dataType: "json",
            data: {},
            type: "GET",
            timeout : timeout,
            success: function(response) {
                $.AMUI.progress.done();
                console.log(response);
                $("#schedule_list tbody").empty();
                response.data.forEach(function(e){
                    var raw = $('<tr>'+
                                '<td class="am-hide-sm-only">'+e.id+'</td>'+
                                '<td class=""><a href="#" class="name">'+e.name+'</a></td>'+
                                '<td class="">'+e.task+'</td>'+
                                '<td class="">'+e.run_type+'</td>'+
                                '<td class="am-hide-sm-only">'+e.enabled+'</td>'+
                                '<td class="am-hide-sm-only">'+e.run_count+'</td>'+
                                '<td class="am-hide-sm-only">'+e.last_update+'</td>'+
                                '</tr>')
                    $("#schedule_list tbody").append(raw)
                });

            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                $.AMUI.progress.done();
                //call failed
                console.log("error");
                $("#error_msg").html("网络连接异常，请稍后重试。");
                $("#errorModal").modal("toggle");
            }
        });
    }
    function load_task(){
        $.AMUI.progress.start();
        console.log("start load user list");
        jQuery.ajax({
            url: "{{url_for('task_config__task')}}",
            dataType: "json",
            data: {},
            type: "GET",
            timeout : timeout,
            success: function(response) {
                $.AMUI.progress.done();
                console.log(response);
                $("#createScheduleTask").empty();
                response.data.forEach(function(e){
                    var raw = $('<option value="'+e+'">'+e+'</option>')
                    $("#createScheduleTask").append(raw)
                });

            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                $.AMUI.progress.done();
                //call failed
                console.log("error");
                $("#error_msg").html("网络连接异常，请稍后重试。");
                $("#errorModal").modal("toggle");
            }
        });
    }
</script>
{% endblock %}
